{% extends "admin/base_admin.html" %}

{% block title %}Migrar Dados para Banco{% endblock %}

{% block content %}
<div class="admin-header">
    <h1><i class="fas fa-database"></i> Migrar Dados para PostgreSQL</h1>
    <p>Migre todos os dados dos arquivos JSON para o banco de dados PostgreSQL</p>
</div>

{% if ja_migrado %}
<div class="alert alert-info">
    <i class="fas fa-info-circle"></i>
    <strong>Dados já migrados!</strong><br>
    Clientes: <strong>{{ clientes_count }}</strong><br>
    Serviços: <strong>{{ servicos_count }}</strong><br>
    <br>
    <small>Você pode executar a migração novamente se necessário. Dados duplicados serão ignorados.</small>
</div>
{% else %}
<div class="alert alert-warning">
    <i class="fas fa-exclamation-triangle"></i>
    <strong>Atenção!</strong> Esta ação irá migrar todos os dados dos arquivos JSON para o banco de dados PostgreSQL.
</div>

{% if debug_info %}
<div class="card" style="margin-top: 20px; background: #f8f9fa;">
    <div class="card-header">
        <h4><i class="fas fa-bug"></i> Informações de Debug</h4>
    </div>
    <div class="card-body">
        <table class="table">
            <tr>
                <td><strong>DATABASE_URL configurado:</strong></td>
                <td>
                    {% if debug_info.has_database_url %}
                        <span class="badge badge-success">Sim</span>
                        <small style="display: block; margin-top: 5px; color: #666;">
                            {{ debug_info.database_url_preview }}
                        </small>
                    {% else %}
                        <span class="badge badge-danger">Não</span>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td><strong>Conexão com banco:</strong></td>
                <td>
                    {% if debug_info.use_database_result %}
                        <span class="badge badge-success">Conectado</span>
                    {% else %}
                        <span class="badge badge-danger">Falhou</span>
                        {% if debug_info.error %}
                            <small style="display: block; margin-top: 5px; color: #dc3545;">
                                Erro: {{ debug_info.error }}
                            </small>
                        {% endif %}
                    {% endif %}
                </td>
            </tr>
        </table>
        {% if not debug_info.has_database_url %}
        <div class="alert alert-danger" style="margin-top: 15px;">
            <i class="fas fa-exclamation-circle"></i>
            <strong>Como configurar:</strong>
            <ol style="margin-top: 10px; margin-bottom: 0;">
                <li>No Render, vá para seu serviço Web</li>
                <li>Clique em "Environment"</li>
                <li>Adicione a variável: <code>DATABASE_URL</code></li>
                <li>Cole a URL do banco PostgreSQL (encontrada em Connections)</li>
                <li>Salve e aguarde o reinício do serviço</li>
            </ol>
        </div>
        {% elif not debug_info.use_database_result %}
        <div class="alert alert-warning" style="margin-top: 15px;">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Problema de conexão:</strong>
            <ul style="margin-top: 10px; margin-bottom: 0;">
                <li>Verifique se o banco de dados está ativo no Render</li>
                <li>Verifique os logs do Render para ver o erro completo</li>
                <li>Confirme que a URL está correta (formato: postgres://...)</li>
            </ul>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}
{% endif %}

<div class="card">
    <div class="card-header">
        <h3>O que será migrado:</h3>
    </div>
    <div class="card-body">
        <ul class="migration-list">
            <li><i class="fas fa-check text-success"></i> Clientes (com todas as ordens de serviço)</li>
            <li><i class="fas fa-check text-success"></i> Serviços</li>
            <li><i class="fas fa-check text-success"></i> Técnicos</li>
            <li><i class="fas fa-check text-success"></i> Slides</li>
            <li><i class="fas fa-check text-success"></i> Footer (configurações)</li>
            <li><i class="fas fa-check text-success"></i> Marcas</li>
            <li><i class="fas fa-check text-success"></i> Milestones</li>
            <li><i class="fas fa-check text-success"></i> Usuários Admin</li>
            <li><i class="fas fa-check text-success"></i> Agendamentos</li>
            <li><i class="fas fa-check text-success"></i> Artigos do Blog</li>
            <li><i class="fas fa-check text-success"></i> Comprovantes</li>
            <li><i class="fas fa-check text-success"></i> Cupons de Fidelidade</li>
            <li><i class="fas fa-check text-success"></i> Contatos</li>
        </ul>
        
        <div class="alert alert-info" style="margin-top: 20px;">
            <i class="fas fa-info-circle"></i>
            <strong>Importante:</strong>
            <ul style="margin-top: 10px; margin-bottom: 0;">
                <li>Os arquivos JSON originais <strong>NÃO serão deletados</strong> (servem como backup)</li>
                <li>A migração é <strong>segura</strong> - dados duplicados serão ignorados</li>
                <li>Após a migração, o sistema usará automaticamente o banco de dados</li>
            </ul>
        </div>
    </div>
</div>

<form method="POST" onsubmit="return confirm('Tem certeza que deseja executar a migração? Esta ação pode levar alguns minutos.');">
    <div class="form-actions">
        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">
            <i class="fas fa-times"></i> Cancelar
        </a>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-database"></i> Executar Migração
        </button>
    </div>
</form>

<style>
.migration-list {
    list-style: none;
    padding: 0;
}
.migration-list li {
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}
.migration-list li:last-child {
    border-bottom: none;
}
.migration-list i {
    margin-right: 10px;
}
</style>
{% endblock %}

