{% extends "admin/base_admin.html" %}

{% block title %}Novo Artigo - Painel Admin{% endblock %}

{% block content %}
<div class="admin-header">
    <h1><i class="fas fa-plus-circle"></i> Novo Artigo</h1>
    <p>Crie um novo artigo para o blog</p>
</div>

<div class="admin-form-card">
    <form method="POST" action="{{ url_for('add_artigo') }}" class="admin-form">
        <div class="form-group">
            <label for="titulo">
                <i class="fas fa-heading"></i>
                T칤tulo do Artigo *
            </label>
            <input type="text" id="titulo" name="titulo" required placeholder="Ex: Como cuidar da bateria do seu celular">
        </div>
        
        <div class="form-group">
            <label for="subtitulo">
                <i class="fas fa-heading"></i>
                Subt칤tulo
            </label>
            <input type="text" id="subtitulo" name="subtitulo" placeholder="Subt칤tulo do artigo (opcional)">
        </div>
        
        <div class="form-group">
            <label for="slug">
                <i class="fas fa-link"></i>
                Slug (URL amig치vel)
            </label>
            <input type="text" id="slug" name="slug" placeholder="Ser치 gerado automaticamente se deixado em branco">
            <small class="form-help">Ex: como-cuidar-da-bateria-do-seu-celular</small>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="data_publicacao">
                    <i class="fas fa-calendar"></i>
                    Data de Publica칞칚o *
                </label>
                <input type="date" id="data_publicacao" name="data_publicacao" required>
            </div>
            
            <div class="form-group">
                <label for="hora_publicacao">
                    <i class="fas fa-clock"></i>
                    Hora de Publica칞칚o *
                </label>
                <input type="time" id="hora_publicacao" name="hora_publicacao" required>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="categoria">
                    <i class="fas fa-tag"></i>
                    Categoria
                </label>
                <input type="text" id="categoria" name="categoria" placeholder="Ex: Dicas, Tutoriais, Not칤cias">
            </div>
            
            <div class="form-group">
                <label for="autor">
                    <i class="fas fa-user"></i>
                    Autor
                </label>
                <input type="text" id="autor" name="autor" placeholder="Equipe Cl칤nica do Reparo">
            </div>
        </div>
        
        <div class="form-group">
            <label for="resumo">
                <i class="fas fa-align-left"></i>
                Resumo
            </label>
            <textarea id="resumo" name="resumo" rows="3" placeholder="Breve descri칞칚o do artigo que aparecer치 na listagem"></textarea>
        </div>
        
        <div class="form-group">
            <label for="imagem_destaque">
                <i class="fas fa-image"></i>
                Imagem de Destaque
            </label>
            <input type="file" id="imagem_destaque_upload" accept="image/png,image/jpeg,image/jpg,image/gif,image/webp" style="display: none;">
            <label for="imagem_destaque_upload" class="btn btn-primary" style="cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; margin-bottom: 10px;">
                <i class="fas fa-upload"></i> Escolher Imagem do Computador
            </label>
            <input type="text" id="imagem_destaque" name="imagem_destaque" placeholder="Caminho da imagem ser치 preenchido automaticamente ap칩s o upload" readonly>
            <small class="form-help">O caminho da imagem ser치 preenchido automaticamente ap칩s o upload.</small>
            <div id="imagem_destaque_preview" style="margin-top: 10px; display: none;">
                <img id="preview_img_destaque" src="" alt="Preview" style="max-width: 300px; max-height: 200px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            <div id="upload_status_destaque" style="margin-top: 5px;"></div>
        </div>
        
        <div class="form-group">
            <label for="conteudo">
                <i class="fas fa-file-alt"></i>
                Conte칰do do Artigo *
            </label>
            <div id="editor-container"></div>
            <textarea id="conteudo" name="conteudo" required style="display: none;"></textarea>
            <small class="form-help">Use o editor acima para formatar o texto, inserir imagens e v칤deos do YouTube.</small>
        </div>
        
        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" id="ativo" name="ativo" checked>
                <span>Artigo ativo (publicado no blog)</span>
            </label>
        </div>
        
        <div class="form-actions">
            <a href="{{ url_for('admin_blog') }}" class="btn btn-secondary" style="background-color: #6c757d; color: white; text-decoration: none;">
                <i class="fas fa-times"></i> Cancelar
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Publicar Artigo
            </button>
        </div>
    </form>
</div>

<!-- Quill Editor - Gratuito e sem necessidade de API -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<style>
#editor-container {
    height: 500px;
    margin-bottom: 50px;
}
.ql-container {
    font-size: 14px;
    font-family: Arial, sans-serif;
}
.ql-youtube {
    position: relative;
    padding-bottom: 56.25%;
    height: 0;
    overflow: hidden;
    max-width: 100%;
    margin: 1rem 0;
}
.ql-youtube iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}
.ql-toolbar button.ql-youtube {
    width: auto;
    padding: 5px 10px;
    font-size: 13px;
    border: 1px solid #ccc;
    border-radius: 3px;
    background: white;
    cursor: pointer;
    margin-left: 5px;
}
.ql-toolbar button.ql-youtube:hover {
    background: #f0f0f0;
}
</style>
<script>
// Definir data e hora padr칚o como agora
document.addEventListener('DOMContentLoaded', function() {
    const hoje = new Date();
    const dataInput = document.getElementById('data_publicacao');
    const horaInput = document.getElementById('hora_publicacao');
    
    if (dataInput && !dataInput.value) {
        dataInput.value = hoje.toISOString().split('T')[0];
    }
    
    if (horaInput && !horaInput.value) {
        const horas = String(hoje.getHours()).padStart(2, '0');
        const minutos = String(hoje.getMinutes()).padStart(2, '0');
        horaInput.value = horas + ':' + minutos;
    }
});

// Gerar slug automaticamente a partir do t칤tulo
document.getElementById('titulo').addEventListener('input', function() {
    const slugInput = document.getElementById('slug');
    if (!slugInput.value) {
        let slug = this.value.toLowerCase()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '')
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-+|-+$/g, '');
        slugInput.value = slug;
    }
});

// Inicializar Quill Editor
var quill = new Quill('#editor-container', {
    theme: 'snow',
    modules: {
        toolbar: {
            container: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'align': [] }],
                ['link', 'image', 'video'],
                ['blockquote', 'code-block'],
                ['clean']
            ],
            handlers: {
                'image': function() {
                    var input = document.createElement('input');
                    input.setAttribute('type', 'file');
                    input.setAttribute('accept', 'image/*');
                    input.click();
                    
                    input.onchange = function() {
                        var file = input.files[0];
                        if (file) {
                            var formData = new FormData();
                            formData.append('imagem', file);
                            
                            var xhr = new XMLHttpRequest();
                            xhr.open('POST', '{{ url_for("upload_imagem_blog") }}');
                            
                            xhr.onload = function() {
                                if (xhr.status === 200) {
                                    var response = JSON.parse(xhr.responseText);
                                    if (response.success) {
                                        var range = quill.getSelection(true);
                                        quill.insertEmbed(range.index, 'image', response.url, 'user');
                                    } else {
                                        alert('Erro ao fazer upload: ' + (response.error || 'Erro desconhecido'));
                                    }
                                } else {
                                    alert('Erro ao fazer upload da imagem');
                                }
                            };
                            
                            xhr.send(formData);
                        }
                    };
                }
            }
        }
    },
    placeholder: 'Escreva o conte칰do do artigo aqui...'
});

// Registrar m칩dulo personalizado para YouTube
var BlockEmbed = Quill.import('blots/block/embed');

class YouTube extends BlockEmbed {
    static create(value) {
        let node = super.create();
        node.setAttribute('src', 'https://www.youtube.com/embed/' + value);
        node.setAttribute('frameborder', '0');
        node.setAttribute('allowfullscreen', 'true');
        node.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture');
        node.style.cssText = 'position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%;';
        let iframe = document.createElement('iframe');
        iframe.setAttribute('src', 'https://www.youtube.com/embed/' + value);
        iframe.setAttribute('frameborder', '0');
        iframe.setAttribute('allowfullscreen', 'true');
        iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture');
        iframe.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%;';
        node.appendChild(iframe);
        return node;
    }
    
    static value(node) {
        return node.getAttribute('src').match(/embed\/([^?]+)/)[1];
    }
}

YouTube.blotName = 'youtube';
YouTube.tagName = 'div';
YouTube.className = 'ql-youtube';

Quill.register(YouTube, true);

// Adicionar bot칚o YouTube customizado na toolbar
setTimeout(function() {
    var youtubeButton = document.createElement('button');
    youtubeButton.type = 'button';
    youtubeButton.innerHTML = '游닠 YouTube';
    youtubeButton.title = 'Inserir v칤deo do YouTube';
    youtubeButton.className = 'ql-youtube';
    youtubeButton.onclick = function() {
        var url = prompt('Cole a URL do v칤deo do YouTube:', '');
        if (url) {
            var videoId = '';
            var regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            var match = url.match(regExp);
            if (match && match[2].length === 11) {
                videoId = match[2];
                var range = quill.getSelection(true);
                quill.insertText(range.index, '\n', 'user');
                quill.insertEmbed(range.index + 1, 'youtube', videoId, 'user');
                quill.setSelection(range.index + 2);
            } else {
                alert('URL do YouTube inv치lida!');
            }
        }
    };
    var toolbar = document.querySelector('.ql-toolbar');
    if (toolbar) {
        toolbar.appendChild(youtubeButton);
    }
}, 100);

// Sincronizar conte칰do do Quill com o textarea antes de enviar
document.querySelector('form').addEventListener('submit', function(e) {
    e.preventDefault(); // Prevenir envio padr칚o
    var content = quill.root.innerHTML;
    document.getElementById('conteudo').value = content;
    
    // Validar se h치 conte칰do
    if (!content || content.trim() === '' || content.trim() === '<p><br></p>') {
        alert('Por favor, preencha o conte칰do do artigo!');
        return false;
    }
    
    // Enviar formul치rio manualmente
    this.submit();
});
</script>

<script>
// Upload de imagem de destaque
const inputFileDestaque = document.getElementById('imagem_destaque_upload');
const inputImagemDestaque = document.getElementById('imagem_destaque');
const previewDestaque = document.getElementById('imagem_destaque_preview');
const uploadStatusDestaque = document.getElementById('upload_status_destaque');

inputFileDestaque.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/webp'];
    if (!allowedTypes.includes(file.type)) {
        uploadStatusDestaque.innerHTML = '<span style="color: red;"><i class="fas fa-times-circle"></i> Tipo de arquivo n칚o permitido. Use: PNG, JPG, JPEG, GIF ou WEBP</span>';
        return;
    }
    
    if (file.size > 5 * 1024 * 1024) {
        uploadStatusDestaque.innerHTML = '<span style="color: red;"><i class="fas fa-times-circle"></i> Arquivo muito grande. Tamanho m치ximo: 5MB</span>';
        return;
    }
    
    uploadStatusDestaque.innerHTML = '<span style="color: #007bff;"><i class="fas fa-spinner fa-spin"></i> Enviando imagem...</span>';
    
    const formData = new FormData();
    formData.append('imagem', file);
    
    fetch('{{ url_for("upload_imagem_blog") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            inputImagemDestaque.value = data.path;
            uploadStatusDestaque.innerHTML = '<span style="color: green;"><i class="fas fa-check-circle"></i> Imagem enviada com sucesso!</span>';
            
            // Atualizar preview
            const img = document.getElementById('preview_img_destaque');
            // Usar o path diretamente se come칞ar com /, sen칚o adicionar /static/
            if (data.path && data.path.startsWith('/')) {
                img.src = data.path;
            } else if (data.url) {
                img.src = data.url;
            } else {
                img.src = '/static/' + (data.path || '');
            }
            previewDestaque.style.display = 'block';
        } else {
            uploadStatusDestaque.innerHTML = '<span style="color: red;"><i class="fas fa-times-circle"></i> ' + (data.error || 'Erro ao enviar imagem') + '</span>';
        }
    })
    .catch(error => {
        uploadStatusDestaque.innerHTML = '<span style="color: red;"><i class="fas fa-times-circle"></i> Erro ao enviar imagem: ' + error.message + '</span>';
    });
});
</script>
{% endblock %}

